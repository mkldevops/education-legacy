{% trans_default_domain 'student' %}
{% set resources = resources|merge({ datatables : true }) %}

{% extends "student/common.html.twig" %}

{% set title = 'title.index'|trans %}

{% block body %}
    {% if students %}
        <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
            {# Header section #}
            <div class="px-6 py-2 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">{{ 'title.index'|trans }}</h2>
                    <div class="flex items-center space-x-3">
                        <span class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                            {{ students|length }} {% trans %}students{% endtrans %}
                        </span>
                    </div>
                </div>
            </div>

            {# Table section #}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 student-table text-sm" data-toggle="datatable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {{ 'list.label.family'|trans }}
                            </th>
                            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nom
                            </th>
                            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Prénom
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {{ 'list.label.phone'|trans }}
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {{ 'list.label.class'|trans }}
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                CP
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Age
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Sexe
                            </th>
                            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for student in students %}
                            {% if student.id is not empty %}
                                {% set classPeriodStudent = student.getClassToPeriod( app.session.get('period').selected )|default(null) %}

                                <tr id="student-{{ student.id }}"
                                    data-id="{{ student.id }}"
                                    data-class-period="{{ classPeriodStudent.classPeriod.id|default(0) }}"
                                    class="student-row hover:bg-gray-50 {{ student.enable ? "" : "student-row danger"}} transition-colors duration-200">

                                    {# Family #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center">
                                        {% if student.person is not empty and student.person.family is not empty %}
                                            <a href="{{ path('app_family_show', { 'id' : student.person.family.id }) }}"
                                               title="{{ student.person.family }}"
                                               class="inline-flex items-center px-2.5 py-1.5 rounded-md text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                                {{ ux_icon('bi:house', {class: 'w-4 h-4 mr-1'}) }}
                                                {{ student.person.family.id }}
                                            </a>
                                        {% else %}
                                            <a href="{{ path('app_student_edit', { 'id' : student.id }) }}#relations"
                                               class="inline-flex items-center px-2.5 py-1.5 rounded-md text-sm font-medium bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors duration-200">
                                                {{ ux_icon('bi:exclamation-triangle', {class: 'w-4 h-4 mr-1'}) }}
                                                {{ 'index.table.header.family.affect'|trans }}
                                            </a>
                                        {% endif %}
                                    </td>

                                    {# Name #}
                                    <td class="px-2 py-2 whitespace-nowrap">
                                        <a href="{{ path('app_student_show', {'id': student.id}) }}"
                                           class="text-sm font-medium text-gray-900 hover:text-primary-600 transition-colors duration-200">
                                            {{ student.name | upper }}
                                        </a>
                                    </td>

                                    {# First Name #}
                                    <td class="px-2 py-2 whitespace-nowrap">
                                        <a href="{{ path('app_student_show', {'id': student.id}) }}"
                                           class="text-sm text-gray-900 hover:text-primary-600 transition-colors duration-200">
                                            {{ student.forname | capitalize }}
                                        </a>
                                    </td>

                                    {# Phone #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center">
                                        {% include 'student/includes/phone.html.twig' %}
                                    </td>

                                    {# Class #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center class-period">
                                        <div class="flex items-center justify-center space-x-2">
                                            {% if classPeriodStudent is not null %}
                                                <a href="{{ path('app_class_period_show', {'id': classPeriodStudent.classPeriod.id }) }}"
                                                   class="inline-flex items-center px-2.5 py-1.5 rounded-md text-sm font-medium bg-green-100 text-green-800 hover:bg-green-200 transition-colors duration-200 class-period-name class-period-{{ classPeriodStudent.classPeriod.id }}">
                                                    {{ ux_icon('bi:folder2-open', {class: 'w-4 h-4 mr-1'}) }}
                                                    {{ classPeriodStudent.classPeriod.classSchool.name }}
                                                </a>
                                            {% elseif classPeriods is defined %}
                                                <span class="inline-flex items-center px-2.5 py-1.5 rounded-md text-sm font-medium bg-gray-100 text-gray-800 class-period-name">
                                                    {{ ux_icon('bi:plus-circle', {class: 'w-4 h-4 mr-1'}) }}
                                                    {{ 'list.label.integrate_class'|trans }}
                                                </span>
                                            {% endif %}

                                            <button type="button"
                                                    class="p-1.5 rounded-full hover:bg-gray-100 transition-colors duration-200"
                                                    @click="$dispatch('open-class-modal', { studentId: {{ student.id }} })"
                                                {% if classPeriodStudent is not empty %}
                                                    {{ ux_icon('bi:box-arrow-right', {class: 'w-4 h-4 text-yellow-600'}) }}
                                                {% else %}
                                                    {{ ux_icon('bi:box-arrow-in-right', {class: 'w-4 h-4 text-green-600'}) }}
                                                {% endif %}
                                            </button>
                                        </div>
                                    </td>

                                    {# ZIP Code with address tooltip #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center">
                                        <span class="text-sm text-gray-900 cursor-help"
                                              data-toggle="tooltip"
                                              title="{{ student.address }}">
                                            {{ student.zip }}
                                        </span>
                                    </td>

                                    {# Age with birthday tooltip #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center">
                                        <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 cursor-help"
                                              data-toggle="tooltip"
                                              data-placement="top"
                                              title="né(e) le {{ student.birthday.format('d/m/Y')|default('unknown') }}">
                                            {{ ux_icon('bi:calendar3', {class: 'w-3 h-3 mr-1'}) }}
                                            {{ student.getAge() }}
                                        </span>
                                    </td>

                                    {# Gender #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center">
                                        <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium
                                                     {% if student.gender == 'male' %}bg-blue-100 text-blue-800{% else %}bg-pink-100 text-pink-800{% endif %}"
                                              data-toggle="tooltip"
                                              title="{{ student.gender|capitalize }}">
                                            {% if student.gender == 'male' %}
                                                {{ ux_icon('bi:person', {class: 'w-3 h-3 mr-1'}) }}
                                            {% else %}
                                                {{ ux_icon('bi:person-standing-dress', {class: 'w-3 h-3 mr-1'}) }}
                                            {% endif %}
                                            {{ student.gender|first|capitalize }}
                                        </span>
                                    </td>




                                    {# Actions dropdown #}
                                    <td class="px-2 py-2 whitespace-nowrap text-center student-setting">
                                        <div class="relative inline-block text-left" x-data="{ open: false }" @click.outside="open = false">
                                            <button type="button"
                                                    class="inline-flex justify-center items-center p-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors duration-200"
                                                    @click="open = !open"
                                                    :aria-expanded="open">
                                                {{ ux_icon('bi:three-dots-vertical', {class: 'w-4 h-4'}) }}
                                            </button>
                                            <ul class="absolute right-0 z-10 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                                                x-show="open"
                                                x-transition:enter="transition ease-out duration-100"
                                                x-transition:enter-start="transform opacity-0 scale-95"
                                                x-transition:enter-end="transform opacity-100 scale-100"
                                                x-transition:leave="transition ease-in duration-75"
                                                x-transition:leave-start="transform opacity-100 scale-100"
                                                x-transition:leave-end="transform opacity-0 scale-95"
                                                role="menu"
                                                x-cloak>
                                                <li>
                                                    <a href="{{ path('app_student_show', {'id': student.id}) }}"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                                                        {{ ux_icon('bi:eye', {class: 'w-4 h-4 mr-3'}) }}
                                                        {{ 'list.action.view'|trans }}
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="{{ path('app_student_edit', {'id': student.id}) }}"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                                                        {{ ux_icon('bi:pencil-square', {class: 'w-4 h-4 mr-3'}) }}
                                                        {{ 'list.action.edit'|trans }}
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#"
                                                       class="student-disable flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors duration-200">
                                                        {{ ux_icon('bi:toggle-off', {class: 'w-4 h-4 mr-3'}) }}
                                                        {{ 'list.action.disable'|trans }}
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Footer section with statistics #}
            <div class="px-6 py-3 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        Affichage de {{ students|length }} étudiant(s)
                    </div>
                    <div class="flex items-center space-x-4">
                        {% set activeStudents = students|filter(s => s.enable) %}
                        {% set inactiveStudents = students|filter(s => not s.enable) %}

                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            {{ activeStudents|length }} actif(s)
                        </span>
                        {% if inactiveStudents|length > 0 %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                {{ inactiveStudents|length }} inactif(s)
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center py-12">
            <div class="max-w-md mx-auto">
                {{ ux_icon('bi:people', {class: 'mx-auto h-12 w-12 text-gray-400'}) }}
                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun étudiant</h3>
                <p class="mt-1 text-sm text-gray-500">Commencez par créer un nouvel étudiant.</p>
                <div class="mt-6">
                    <a href="{{ path('app_student_new') }}"
                       class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                        {{ ux_icon('bi:plus-lg', {class: 'w-4 h-4 mr-2'}) }}
                        Nouveau étudiant
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    {% include 'components/class_period_modal.html.twig' %}
{% endblock %}
{% block javascripts %}
    {{ parent() }}
{% endblock %}
