{% trans_default_domain 'student' %}

{% set packagePeriods = this.packagePeriods %}
{% set summary = this.summary %}

<div {{ attributes }} class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">
            {{ ux_icon('tabler:calendar-dollar', {class: 'w-5 h-5 mr-2 inline'}) }}
            Forfaits & paiements
        </h3>
        {% if summary.count > 0 %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                {{ summary.count }} forfait{{ summary.count > 1 ? 's' : '' }}
            </span>
        {% endif %}
    </div>

    <div class="p-6 space-y-6">
        {% if packagePeriods %}
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <dt class="text-sm font-medium text-gray-500">Montant engagé</dt>
                    <dd class="mt-1 text-lg font-semibold text-gray-900">{{ summary.amount|number_format(2, ',', ' ') }} €</dd>
                </div>
                <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <dt class="text-sm font-medium text-gray-500">Total payé</dt>
                    <dd class="mt-1 text-lg font-semibold text-emerald-600">{{ summary.paid|number_format(2, ',', ' ') }} €</dd>
                </div>
                <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <dt class="text-sm font-medium text-gray-500">Remises</dt>
                    <dd class="mt-1 text-lg font-semibold text-purple-600">{{ summary.discount|number_format(2, ',', ' ') }} €</dd>
                </div>
                <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <dt class="text-sm font-medium text-gray-500">Reste à payer</dt>
                    <dd class="mt-1 text-lg font-semibold {{ summary.unpaid > 0 ? 'text-red-600' : 'text-emerald-600' }}">
                        {{ summary.unpaid|number_format(2, ',', ' ') }} €
                    </dd>
                </div>
            </dl>

            <div class="space-y-2">
                {% for packagePeriod in packagePeriods %}
                    {% set meta = this.statusMeta(packagePeriod) %}
                    {% set amount = packagePeriod.amount|default(0) %}
                    {% set discount = packagePeriod.discount|default(0) %}
                    {% set unpaid = max([packagePeriod.unpaid|default(0), 0]) %}
                    {% set paid = max([amount - discount - unpaid, 0]) %}
                    {% set percent = packagePeriod.percentPayments|default(0) %}
                    {% set progress = percent < 0 ? 0 : (percent > 100 ? 100 : percent) %}

                    <article x-data="{ open: {{ loop.first ? 'true' : 'false' }} }" class="border border-gray-200 rounded-lg shadow-sm">
                        <button type="button"
                                @click="open = !open"
                                class="w-full flex items-center justify-between gap-4 px-5 py-2 text-left hover:bg-gray-50 transition-colors duration-200">
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-gray-500">{{ packagePeriod.period }}</p>
                                <h4 class="text-base font-semibold text-gray-900 truncate">
                                    {{ ux_icon('tabler:box', {class: 'w-4 h-4 text-gray-400 inline mr-2'}) }}
                                    {{ packagePeriod.package }}
                                </h4>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="inline-flex items-center px-3 py-1 border text-xs font-medium rounded-full {{ meta.badge }}">
                                    {{ ux_icon(meta.icon, {class: 'w-4 h-4 mr-1'}) }}
                                    {{ meta.label }}
                                </span>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" :class="{ 'rotate-180': open }" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.25 8.27a.75.75 0 01-.02-1.06z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </button>

                        <div x-cloak x-show="open" x-transition class="px-5 pb-2 space-y-2 border-t border-gray-200">
                            <div class="pt-5 grid grid-cols-2 gap-4 text-sm text-gray-600">
                                <div>
                                    <span class="block text-xs uppercase tracking-wide text-gray-400">Montant</span>
                                    <span class="font-semibold text-gray-900">{{ amount|number_format(2, ',', ' ') }} €</span>
                                </div>
                                <div>
                                    <span class="block text-xs uppercase tracking-wide text-gray-400">Payé</span>
                                    <span class="font-semibold text-emerald-600">{{ paid|number_format(2, ',', ' ') }} €</span>
                                </div>
                                <div>
                                    <span class="block text-xs uppercase tracking-wide text-gray-400">Remise</span>
                                    <span class="font-semibold text-purple-600">{{ discount|number_format(2, ',', ' ') }} €</span>
                                </div>
                                <div>
                                    <span class="block text-xs uppercase tracking-wide text-gray-400">Reste</span>
                                    <span class="font-semibold {{ unpaid > 0 ? 'text-red-600' : 'text-emerald-600' }}">{{ unpaid|number_format(2, ',', ' ') }} €</span>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>Taux de paiement</span>
                                    <span>{{ percent|round(0, 'floor') }}%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-100 rounded-full">
                                    <div class="h-2 rounded-full {{ meta.progress }}" style="width: {{ progress }}%;"></div>
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center justify-between gap-3 text-xs text-gray-500">
                                <div class="flex items-center gap-1">
                                    {{ ux_icon('tabler:calendar-event', {class: 'w-4 h-4'}) }}
                                    {% if packagePeriod.dateExpire is not empty %}
                                        Échéance&nbsp;: {{ packagePeriod.dateExpire|date('d/m/Y') }}
                                    {% else %}
                                        Aucune échéance
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-1">
                                    {{ ux_icon('tabler:user', {class: 'w-4 h-4'}) }}
                                    Dernière mise à jour&nbsp;:
                                    {{ packagePeriod.updatedAt is not empty ? packagePeriod.updatedAt|date('d/m/Y') : packagePeriod.createdAt|date('d/m/Y') }}
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                {% if packagePeriod.comment %}
                                    <p class="text-xs text-gray-500 truncate max-w-xs" title="{{ packagePeriod.comment }}">
                                        {{ ux_icon('tabler:message', {class: 'w-4 h-4 inline text-gray-400 mr-1'}) }}
                                        {{ packagePeriod.comment }}
                                    </p>
                                {% else %}
                                    <span class="text-xs text-gray-400">
                                        {{ ux_icon('tabler:message', {class: 'w-4 h-4 inline text-gray-300 mr-1'}) }}
                                        Aucun commentaire
                                    </span>
                                {% endif %}
                                <span class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-400">
                                    {{ ux_icon('tabler:eye', {class: 'w-4 h-4 mr-1'}) }}
                                    {{ packagePeriod.package.name }}
                                </span>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-10">
                <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-blue-50 text-blue-500">
                    {{ ux_icon('tabler:calendar-x', {class: 'w-6 h-6'}) }}
                </div>
                <p class="mt-4 text-sm font-medium text-gray-900">Aucun forfait attribué</p>
                <p class="mt-1 text-sm text-gray-500">Enregistrez un forfait pour suivre les paiements de l'élève.</p>
                {% if this.student is not empty and this.student.family is not empty %}
                    <a href="{{ path('app_family_show', {id: this.student.family.id}) }}"
                       class="mt-4 inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-md shadow-sm">
                        {{ ux_icon('tabler:calendar-plus', {class: 'w-4 h-4 mr-2'}) }}
                        Ajouter un forfait
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
