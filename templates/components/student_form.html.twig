{% trans_default_domain 'family' %}

<div x-data="{ 
    showModal: false, 
    successMessage: '', 
    errorMessage: '',
    
    openModal() {
        this.showModal = true;
        this.successMessage = '';
        this.errorMessage = '';
    },
    
    closeModal() {
        this.showModal = false;
        this.successMessage = '';
        this.errorMessage = '';
    },
    
    async submitForm(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        try {
            const response = await fetch('{{ path('app_student_create') }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                this.successMessage = 'L\'étudiant a été ajouté avec succès.';
                this.showModal = false;
                // Refresh the page to show the new student
                setTimeout(() => location.reload(), 1500);
            } else {
                const errorData = await response.text();
                console.error('Error response:', errorData);
                this.errorMessage = 'Une erreur est survenue lors de l\'enregistrement.';
            }
        } catch (error) {
            this.errorMessage = 'Une erreur est survenue lors de l\'enregistrement.';
        }
    }
}">
    <!-- Success Message -->
    <div x-show="successMessage" x-transition class="mb-4 bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg">
        <span x-text="successMessage"></span>
    </div>

    <!-- Error Message -->
    <div x-show="errorMessage" x-transition class="mb-4 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
        <span x-text="errorMessage"></span>
    </div>

    <!-- Trigger Button -->
    <button 
        @click="openModal()"
        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
        {{ ux_icon('tabler:user-plus', {class: 'w-4 h-4 mr-2'}) }}
        {{ 'new_student'|trans }}
    </button>

    <!-- Modal -->
    <div x-show="showModal" x-cloak @click.away="closeModal()" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            
            <div @click.stop class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="bg-blue-100 rounded-full p-2 mr-3">
                                {{ ux_icon('tabler:user-plus', {class: 'w-5 h-5 text-blue-600'}) }}
                            </div>
                            <h4 class="text-lg font-medium text-gray-900">{{ 'new_student'|trans }}</h4>
                        </div>
                        <button 
                            type="button"
                            @click="closeModal()"
                            class="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition ease-in-out duration-150">
                            {{ ux_icon('tabler:x', {class: 'w-6 h-6'}) }}
                        </button>
                    </div>
                </div>

                <form @submit="submitForm" class="space-y-6">
                    <input type="hidden" name="_token" value="{{ csrf_token('app_student') }}">
                    {% if family %}
                        <input type="hidden" name="app_student[person][family]" value="{{ family.id }}">
                    {% endif %}
                    
                    <div class="px-6 py-4 space-y-6">
                        <!-- Personal Information -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Informations personnelles</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="app_student_person_name" class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                                    <input type="text" id="app_student_person_name" name="app_student[person][name]" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="app_student_person_forname" class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                                    <input type="text" id="app_student_person_forname" name="app_student[person][forname]" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Gender & Grade -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Genre et niveau</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="app_student_person_gender" class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                                    <select id="app_student_person_gender" name="app_student[person][gender]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="">Sélectionner un genre</option>
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="app_student_grade" class="block text-sm font-medium text-gray-700 mb-1">Niveau</label>
                                    <input type="text" id="app_student_grade" name="app_student[grade]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Birth Information -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Informations de naissance</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="app_student_person_birthday" class="block text-sm font-medium text-gray-700 mb-1">Date de naissance</label>
                                    <input type="date" id="app_student_person_birthday" name="app_student[person][birthday]" class="datepicker block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="app_student_person_birthplace" class="block text-sm font-medium text-gray-700 mb-1">Lieu de naissance</label>
                                    <input type="text" id="app_student_person_birthplace" name="app_student[person][birthplace]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Contact</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="app_student_person_email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="app_student_person_email" name="app_student[person][email]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="app_student_person_phone" class="block text-sm font-medium text-gray-700 mb-1">Téléphone</label>
                                    <input type="tel" id="app_student_person_phone" name="app_student[person][phone]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- School Information -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Informations scolaires</h5>
                            <div>
                                <label for="app_student_lastSchool" class="block text-sm font-medium text-gray-700 mb-1">Dernière école</label>
                                <input type="text" id="app_student_lastSchool" name="app_student[lastSchool]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="space-y-4">
                            <h5 class="text-sm font-medium text-gray-900 border-b border-gray-200 pb-2">Informations complémentaires</h5>
                            <div>
                                <label for="app_student_remarksHealth" class="block text-sm font-medium text-gray-700 mb-1">Remarques santé</label>
                                <textarea id="app_student_remarksHealth" name="app_student[remarksHealth]" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
                            </div>
                            <div>
                                <label for="app_student_personAuthorized" class="block text-sm font-medium text-gray-700 mb-1">Personnes autorisées</label>
                                <textarea id="app_student_personAuthorized" name="app_student[personAuthorized]" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="app_student_letAlone" name="app_student[letAlone]" value="1" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <div class="ml-3">
                                    <label for="app_student_letAlone" class="text-sm font-medium text-gray-700">Autoriser à partir seul(e)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                        <button 
                            type="button"
                            @click="closeModal()"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {{ ux_icon('tabler:x', {class: 'w-4 h-4 mr-2'}) }}
                            Annuler
                        </button>
                        <button 
                            type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {{ ux_icon('tabler:check', {class: 'w-4 h-4 mr-2'}) }}
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>