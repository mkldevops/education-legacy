{% extends 'family/common.html.twig' %}

{% trans_default_domain 'family' %}

{% set title = 'show.title'|trans({ '%family%' : family }) %}

{% block title %}
    {{ title }} / {{ parent() }}
{% endblock %}

{% set breadcrumbs = { ('' ~ title) : path('app_family_show', {id : family.id })}|merge(breadcrumbs|default({})) %}

{% block body %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Family Information -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="bg-green-100 rounded-full p-2 mr-3">
                            {{ ux_icon('tabler:info-circle', {class: 'w-5 h-5 text-green-600'}) }}
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">{{ 'title.header.info'|trans({'%id%' : family.id }) | raw }}</h2>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Family Members -->
                        <div class="space-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.father'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    {% if family.father|default(null) is not empty %}
                                        <span class="text-gray-900">{{ family.father }}</span>
                                    {% else %}
                                        <span class="text-gray-400">Non renseigné</span>
                                    {% endif %}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.mother'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    {% if family.mother|default(null) is not empty %}
                                        <span class="text-gray-900">{{ family.mother }}</span>
                                    {% else %}
                                        <span class="text-gray-400">Non renseigné</span>
                                    {% endif %}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.legalguardian'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    {% if family.legalGuardian|default(null) is not empty %}
                                        <span class="text-gray-900">{{ family.legalGuardian }}</span>
                                    {% else %}
                                        <span class="text-gray-400">Non renseigné</span>
                                    {% endif %}
                                </dd>
                            </div>
                        </div>

                        <!-- Family Details -->
                        <div class="space-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.language'|trans }}</dt>
                                <dd class="mt-1">
                                    {% if family.language %}
                                        <span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">{{ family.language|upper }}</span>
                                    {% else %}
                                        <span class="text-gray-400">Non renseigné</span>
                                    {% endif %}
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.numberchildren'|trans }}</dt>
                                <dd class="mt-1">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ ux_icon('tabler:users', {class: 'w-3 h-3 mr-1'}) }}
                                        {{ family.numberChildren }}
                                    </span>
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.address'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ family.address ?: 'Non renseigné' }}</dd>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">{{ 'show.label.city'|trans }}</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ family.city ?: 'Non renseigné' }}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">{{ 'show.label.zip'|trans }}</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ family.zip ?: 'Non renseigné' }}</dd>
                                </div>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.enable'|trans }}</dt>
                                <dd class="mt-1">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full {{ family.enable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' }}">
                                        {% if family.enable %}Oui{% else %}Non{% endif %}
                                    </span>
                                </dd>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-xs text-gray-500">
                            {{ 'show.label.created'|trans({
                                '%created_at%' : family.createdAt|date('d/m/Y H:i:s'),
                                '%updated_at%' : family.updatedAt|date('d/m/Y H:i:s')
                            }) }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-2">
            <!-- Contact Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="bg-purple-100 rounded-full p-2 mr-3">
                            {{ ux_icon('tabler:phone', {class: 'w-5 h-5 text-purple-600'}) }}
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">{{ 'title.header.contacts'|trans }}</h2>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-1">
                        {% if family.mother.phone|default(null) %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">{{ 'show.label.mother'|trans }}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="tel:{{ family.mother.phone|trim|replace({' ': ''}) }}" class="text-blue-600 hover:text-blue-800">{{ family.mother.phone }}</a>
                            </dd>
                        </div>
                        {% endif %}
                        {% if family.father.phone|default(null) %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.father'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    <a href="tel:{{ family.father.phone|trim|replace({' ': ''}) }}" class="text-blue-600 hover:text-blue-800">{{ family.father.phone }}</a>
                                </dd>
                            </div>
                        {% endif %}
                        {% if family.legalGuardian.phone|default(null) %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">{{ 'show.label.legalguardian'|trans }}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <a href="tel:{{ family.legalGuardian.phone|trim|replace({' ': ''}) }}" class="text-blue-600 hover:text-blue-800">{{ family.legalGuardian.phone }}</a>
                            </dd>
                        </div>
                        {% endif %}
                        {% if family.email|default(null) %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">{{ 'show.label.email'|trans }}</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    <a href="mailto:{{ family.email|trim|replace({' ': ''})|lower }}" class="text-blue-600 hover:text-blue-800">{{ family.email|trim|replace({' ': ''})|lower }}</a>
                                </dd>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Authorization -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="bg-red-100 rounded-full p-2 mr-3">
                            {{ ux_icon('tabler:shield-check', {class: 'w-5 h-5 text-red-600'}) }}
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">{{ 'title.header.authorization'|trans }}</h2>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">{{ 'show.label.personauthorized'|trans }}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if family.personAuthorized %}
                                    {{ family.personAuthorized|raw }}
                                {% else %}
                                    <span class="text-gray-400 italic">{{ 'show.value.nothing'|trans }}</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">{{ 'show.label.personemergency'|trans }}</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if family.personEmergency %}
                                    {{ family.personEmergency|raw }}
                                {% else %}
                                    <span class="text-gray-400 italic">{{ 'show.value.nothing'|trans }}</span>
                                {% endif %}
                            </dd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students List -->
    <div class="mt-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-indigo-100 rounded-full p-2 mr-3">
                            {{ ux_icon('tabler:school', {class: 'w-5 h-5 text-indigo-600'}) }}
                        </div>
                        <h2 class="text-lg font-medium text-gray-900">{{ 'title.header.persons'|trans }}</h2>
                    </div>
                    <div class="flex space-x-2">
                        {{ component('student_form', { family: family }) }}
                        {{ component('payment_package_student', { family: family, period: period }) }}
                    </div>
                </div>
            </div>

            {% if persons %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.name'|trans }}</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.age'|trans }}</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.gender'|trans }}</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.class'|trans }}</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.package'|trans({ '%period%' : period }) }}</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'show.list.person.to_pay'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% set unpaid_total = 0 %}
                            {% for person in persons %}
                                {% set enable = person.student.enable|default(false) %}
                                <tr class="{{ enable ? 'hover:bg-gray-50' : 'opacity-60 italic' }}">
                                    <td class="px-6 py-2 whitespace-nowrap text-center">
                                        {% if person.image is not empty %}
                                            <div class="flex justify-center">
                                                <img src="{{ person.image.path }}" alt="{{ person }}" class="w-10 h-10 rounded-full object-cover">
                                            </div>
                                        {% else %}
                                            <div class="flex justify-center">
                                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                                    {{ ux_icon('tabler:user', {class: 'w-5 h-5 text-gray-400'}) }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        {% if person.student is not empty %}
                                            <a href="{{ path('app_student_show', { id : person.student.id }) }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ person }}</a>
                                        {% else %}
                                            <span class="text-gray-900">{{ person }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">{{ person.age }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">{{ person.gender }}</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        {% if enable and person.student.classPeriods.first.classPeriod|default(null) is not empty %}
                                            <a href="{{ path('app_class_period_show', { id : person.student.classPeriods.first.classPeriod.id }) }}" class="text-blue-600 hover:text-blue-800">{{ person.student.classPeriods.first.classPeriod }}</a>
                                        {% else %}
                                            <span class="text-gray-400">---</span>
                                        {% endif %}
                                    </td>
                                    {% set pp = enable ? person.student.packagePeriods.first|default(null) : null %}
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        {% if pp is not empty %}
                                            <a href="{{ path('app_package_student_period_show', {'id': pp.id }) }}" class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-white">{{ pp.period }} {{ pp.package }}</a>
                                        {% elseif enable %}
                                            <button type="button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="openPackageModal({{ person.student.id }})">
                                                {{ ux_icon('tabler:calendar-plus', {class: 'w-3 h-3 mr-1'}) }}
                                                {{ 'new_package_student'|trans({'%period%' : period}) }}
                                            </button>
                                        {% else %}
                                            <span class="text-gray-400">---</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        {% if pp is not empty %}
                                            {% set unpaid = pp.unpaid %}
                                            {% if unpaid <= 0 %}
                                                <a href="{{ path('app_student_show', {'id': person.student.id }) }}" class="text-green-600">
                                                    {{ ux_icon('tabler:circle-check', {class: 'w-5 h-5'}) }}
                                                </a>
                                            {% else %}
                                                {% set unpaid_total = unpaid_total + unpaid %}
                                                <a href="{{ path('app_student_show', {'id': person.student.id }) }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ unpaid|number_format(2) }} €</a>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-gray-400">---</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <th colspan="6" class="px-6 py-4 text-right text-sm font-semibold text-gray-900">{{ 'show.total_to_pay'|trans }}</th>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    {% if unpaid_total > 0 %}
                                        <span class="text-lg font-bold text-blue-600">{{ unpaid_total|number_format(2) }} €</span>
                                    {% else %}
                                        <span class="text-green-600">
                                            {{ ux_icon('tabler:circle-check', {class: 'w-6 h-6'}) }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                {% include 'family/includes/_modal_form_package_student_period.html.twig' %}

            {% else %}
                <div class="p-12 text-center">
                    <div class="flex flex-col items-center">
                        <div class="bg-gray-100 rounded-full p-4 mb-4">
                            {{ ux_icon('tabler:users', {class: 'w-8 h-8 text-gray-400'}) }}
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">{{ 'nothing.person'|trans }}</h3>
                        <p class="text-gray-500">Aucune personne trouvée pour cette famille.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/student-api.js') }}"></script>
    <script src="{{ asset('js/package-api.js') }}"></script>
{% endblock %}
